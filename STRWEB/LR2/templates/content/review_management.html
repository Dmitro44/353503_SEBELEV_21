{% extends 'base.html' %}

{% block title %}Управление отзывами - Автопрокат{% endblock %}

{% block content %}
    <div>
        <div>
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>Управление отзывами</h1>
                    <a href="{% url 'review_list' %}">Просмотр отзывов на сайте</a>
                </div>

                <!-- Фильтры -->
                <div>
                    <h5>Фильтры</h5>
                    <form method="get">
                        <div>
                            <label for="approved">Статус отзыва</label>
                            <select name="approved" id="approved">
                                <option value="" {% if approved_filter == '' %}selected{% endif %}>Все отзывы</option>
                                <option value="true" {% if approved_filter == 'true' %}selected{% endif %}>Опубликованные</option>
                                <option value="false" {% if approved_filter == 'false' %}selected{% endif %}>Ожидающие проверки</option>
                            </select>
                        </div>
                        <div>
                            <button type="submit">Применить</button>
                            <a href="{% url 'review_management' %}">Сбросить</a>
                        </div>
                    </form>
                </div>

                <!-- Статистика -->
                <div>
                    Ожидают проверки: <strong>{{ pending_count }}</strong> отзывов
                </div>

                <!-- Таблица отзывов -->
                {% if reviews %}
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Пользователь</th>
                            <th>Рейтинг</th>
                            <th>Текст отзыва</th>
                            <th>Дата</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for review in reviews %}
                            <tr>
                                <td>{{ review.pk }}</td>
                                <td>{{ review.user.get_full_name|default:review.user.username }}</td>
                                <td>
                                    ({{ review.rating }}/5)
                                </td>
                                <td>{{ review.text|truncatechars:100 }}</td>
                                <td>{{ review.created_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    {% if review.approved %}
                                        <span>Опубликован</span>
                                    {% else %}
                                        <span>Ожидает проверки</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not review.approved %}
                                        <div style="display: flex;">
                                            <form method="post" action="{% url 'review_approve' review.pk %}" style="margin-right: 1em;">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="approve">
                                                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                                <button type="submit">Одобрить</button>
                                            </form>
                                            <form method="post" action="{% url 'review_approve' review.pk %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="reject">
                                                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                                <button type="submit" onclick="return confirm('Вы уверены, что хотите отклонить этот отзыв?');">Отклонить</button>
                                            </form>
                                        </div>
                                    {% else %}
                                        <button disabled>Уже опубликован</button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                {% else %}
                    <div>
                        Нет отзывов, соответствующих заданным критериям.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}